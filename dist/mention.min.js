"use strict";var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i["return"]&&_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();angular.module("ui.mention",[]).directive("uiMention",function(){return{require:["ngModel","uiMention"],controller:"uiMention",controllerAs:"$mention",link:function($scope,$element,$attrs,_ref){var _ref2=_slicedToArray(_ref,2),ngModel=_ref2[0],uiMention=_ref2[1];uiMention.init(ngModel)}}}),angular.module("ui.mention").controller("uiMention",["$element","$scope","$attrs","$q","$timeout","$document",function($element,$scope,$attrs,$q,$timeout,$document){function getDefaultConfig(config){config=config||{};var delimiter=config.delimiter||"@",label=config.label||function(choice){return choice.first+" "+choice.last};return{delimiter:delimiter,searchPattern:config.searchPattern||new RegExp("(?:\\s+|^)"+delimiter+"(\\w+(?: \\w+)?)$"),decodePattern:config.decodePattern||new RegExp(delimiter+"[[\\s\\w]+:[0-9a-z-]+]","gi"),label:label,findChoices:config.findChoices||function(match,mentions){return[]},encode:config.encode||function(choice){return delimiter+"["+label(choice)+":"+choice.id+"]"},mentions:[],highlight:config.highlight||function(choice){return"<span>"+label(choice)+"</span>"}}}function parseContentAsText(content){try{return temp.textContent=content,temp.innerHTML}finally{temp.textContent=null}}var _this3=this;this.delimiter="@",this.searchPattern=this.pattern||new RegExp("(?:\\s+|^)"+this.delimiter+"(\\w+(?: \\w+)?)$"),this.decodePattern=new RegExp(this.delimiter+"[[\\s\\w]+:[0-9a-z-]+]","gi"),this.currentConfig=void 0,this.config=this.config&&this.config.map(function(config){return getDefaultConfig(config)})||[getDefaultConfig()],this.setConfig=function(configs){var _this=this;this.config=configs&&configs.map(function(config){return getDefaultConfig(config)})||[getDefaultConfig()];for(var _loop=function(){var config=_this.config[i];ngModel.$parsers.push(function(value){return config.mentions=config.mentions.filter(function(mention){if(~value.indexOf(config.label(mention)))return value=value.replace(config.label(mention),config.encode(mention))}),_this.render(value),value}),ngModel.$formatters.push(function(){var value=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return value=value.toString(),config.mentions=config.mentions.filter(function(mention){return!!~value.indexOf(config.encode(mention))&&(value=value.replace(config.encode(mention),config.label(mention)),!0)}),value})},i=0;i<this.config.length;i++)_loop()},this.$element=$element,this.choices=[],this.mentions=[];var ngModel;this.init=function(model){var _this2=this;$attrs.ngTrim="false",ngModel=model,ngModel.$render=function(){$element.val(ngModel.$viewValue||""),$timeout(_this2.autogrow,!0),_this2.render()}};var temp=document.createElement("span");this.render=function(){var html=arguments.length<=0||void 0===arguments[0]?ngModel.$modelValue:arguments[0];return html=(html||"").toString(),html=parseContentAsText(html),_this3.config.forEach(function(config){config.mentions.forEach(function(mention){config.encode(mention),config.highlight(mention);html=html.replace(config.encode(mention),config.highlight(mention))})}),_this3.renderElement().html(html),html},this.renderElement=function(){return $element.next()},this.highlight=function(choice){return"<span>"+this.currentConfig.label(choice)+"</span>"},this.decode=function(){var value=arguments.length<=0||void 0===arguments[0]?ngModel.$modelValue:arguments[0];return value?value.replace(this.decodePattern,"$1"):""},this.label=function(choice){return choice.first+" "+choice.last},this.encode=function(choice){return this.currentConfig.delimiter+"["+this.currentConfig.label(choice)+":"+choice.id+"]"},this.replace=function(mention){var search=arguments.length<=1||void 0===arguments[1]?this.searching:arguments[1],text=arguments.length<=2||void 0===arguments[2]?ngModel.$viewValue:arguments[2];return text=text.substr(0,search.index+search[0].indexOf(this.currentConfig.delimiter))+this.currentConfig.label(mention)+" "+text.substr(search.index+search[0].length)},this.select=function(){var choice=arguments.length<=0||void 0===arguments[0]?this.activeChoice:arguments[0];return!!choice&&(this.currentConfig.mentions.push(choice),ngModel.$setViewValue(this.replace(choice)),this.cancel(),void ngModel.$render())},this.up=function(){var index=this.choices.indexOf(this.activeChoice);index>0?this.activeChoice=this.choices[index-1]:this.activeChoice=this.choices[this.choices.length-1]},this.down=function(){var index=this.choices.indexOf(this.activeChoice);index<this.choices.length-1?this.activeChoice=this.choices[index+1]:this.activeChoice=this.choices[0]},this.search=function(match){var _this4=this;return this.searching=match,$q.when(this.currentConfig.findChoices(match,this.currentConfig.mentions)).then(function(choices){return _this4.choices=choices,_this4.activeChoice=choices[0],choices})},this.findChoices=function(match,mentions){return[]},this.cancel=function(){this.choices=[],this.searching=null},this.autogrow=function(){$element[0].style.height=0;var style=getComputedStyle($element[0]);"border-box"==style.boxSizing&&($element[0].style.height=$element[0].scrollHeight+"px")},$element.on("keyup click focus",function(event){if(_this3.moved)return _this3.moved=!1;if($element[0].selectionStart==$element[0].selectionEnd){for(var text=$element.val(),match=void 0,i=0;i<_this3.config.length;i++)if(match=_this3.config[i].searchPattern.exec(text.substr(0,$element[0].selectionStart))){_this3.currentConfig=_this3.config[i],_this3.search(match);break}match||_this3.cancel(),$scope.$$phase||$scope.$apply()}}),$element.on("keydown",function(event){if(_this3.searching){switch(event.keyCode){case 13:_this3.select();break;case 38:_this3.up();break;case 40:_this3.down();break;default:return}_this3.moved=!0,event.preventDefault(),$scope.$$phase||$scope.$apply()}}),this.onMouseup=function(event){var _this5=this;event.target!=$element[0]&&($document.off("mouseup",this.onMouseup),this.searching&&$scope.$evalAsync(function(){_this5.cancel()}))}.bind(this),$element.on("focus",function(event){$document.on("mouseup",_this3.onMouseup)}),$element.on("input",this.autogrow),$timeout(this.autogrow,!0)}]);